# 智慧物流车队与配送管理系统 — 运行说明（对外分享用）

本项目包含：SQL Server 数据库脚本 + Flask 最小可运行 Web 界面。按本文档操作，零基础环境亦可启动并体验核心功能与触发器效果。

---

## 一、运行所需环境
- 操作系统：Windows 10/11
- 数据库：SQL Server（建议配套安装 SSMS 19）
- Python：3.8 及以上
- ODBC 驱动：ODBC Driver 17 for SQL Server（若无需到微软官网安装）

---

## 二、初始化数据库（只需一次）
1) 打开 SQL Server Management Studio（SSMS）并连接本地实例（服务器名可用 `localhost`）。
2) 在 SSMS 依次执行脚本：
   - 打开并执行：`sql/init_all.sql`
   - 看到“数据库初始化完成、配送中心 3 个、车队 6 个”的提示即成功。

说明：`init_all.sql` 会创建所有表、索引、触发器、视图、存储过程，并插入基础数据。

---

## 三、启动 Web 应用（首选一键启动）
推荐使用一键脚本，无需手动设置环境变量。

1. 进入目录：`web/flask_app`
2. 双击运行：`run.bat`
   - 脚本会自动创建虚拟环境、安装依赖并启动网页。
   - 首次运行可能需要等待几分钟安装依赖。
3. 浏览器访问：`http://localhost:5000`

端口与数据库配置可在同目录 `.env` 修改：
```
PORT=5000
SQLSERVER_SERVER=localhost
SQLSERVER_DB=LogisticsDB
# 如使用账号密码认证，取消注释并填写：
# SQLSERVER_USER=sa
# SQLSERVER_PASSWORD=YourStrong!Passw0rd
```
端口占用时将 `PORT` 设为 `5001` 再启动。

---

## 四、系统入口与功能一览
- 主页：`/`
- 司机管理：`/drivers`（表单校验：必填、驾照枚举）
- 车辆管理：`/vehicles`（表单校验：必填、车牌正则、状态枚举）
- 运单分配：`/orders/assign`（选择空闲车辆；超载由触发器拦截并提示）
- 异常记录：`/exceptions`（新增即将车辆置为“异常”）
- 异常处理：`/exceptions/process`（标记处理→触发器自动恢复车辆状态并写入审计）
- 周异常视图：`/views/week_exceptions`（最近 7 天异常）
- 车队月报：`/reports/fleet_monthly`（调用存储过程统计月度指标）

---

## 五、建议体验路径（用于演示/验收）
1) 在“车辆管理”新增车辆：如车牌 `A12345`，载重 `5000`。
2) 在“司机管理”新增司机：如工号 `D001`，驾照 `C1`。
3) 在“运单分配”正常分配一单（重量 1000）。车辆自动变为“运输中”。
4) 再次分配超载订单（重量 5000）
   - 触发器抛错并前端弹出“超出最大载重”。
5) 在“异常记录”新增异常（车辆故障、罚款 500）
   - 车辆状态自动置为“异常”。
6) 在“异常处理”标记已处理
   - 触发器根据是否仍有未完成运单自动将车辆恢复为“运输中”或“空闲”，并写入审计表 `History_Log`。
7) 查看“周异常视图”和“车队月报”。

---

## 六、常见问题 & 处理
- 浏览器“无法访问此页面/拒绝连接”：
  - 检查服务是否在运行（PowerShell 有无“Running on http://127.0.0.1:5000”）
  - 端口占用：修改 `.env` 中 `PORT=5001`，重启
- 启动时报 `ModuleNotFoundError`：
  - 未激活虚拟环境或依赖未装；使用 `run.bat` 或 `start.ps1` 自动处理
- 数据库连接失败（pyodbc 错误）：
  - 安装 ODBC Driver 17；确保 SQL Server 服务运行；`.env` 的服务器/库名正确
- 脚本被策略拦截：执行一次
  ```powershell
  Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
  ```

---

## 七、目录结构（对使用者）
```
DATABASE_project/
├─ sql/                 # 数据库脚本（init_all.sql 可一键初始化）
└─ web/
   └─ flask_app/
      ├─ app.py         # Flask 应用入口
      ├─ templates/     # 页面模板
      ├─ start.ps1      # PowerShell 启动脚本
      ├─ run.bat        # 一键启动（双击）
      ├─ .env           # 运行配置（端口/数据库参数）
      └─ requirements.txt
```

如需任何帮助或遇到异常启动输出，请将 PowerShell 的报错截图发送给我以便快速定位。